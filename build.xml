<?xml version="1.0" encoding="UTF-8"?>
<!-- Thanks to Benoit Cerrina <b.cerrina@wanadoo.fr> for this buildfile. -->

<project basedir="." default="create-jar" name="JRuby">
  <description>
    JRuby is a pure Java implementation of a Ruby interpreter.
  </description>

  <property name="base.dir"
            value="."/>
  <property name="src.dir"
            value="${base.dir}/src"/>
  <property name="test.dir"
            value="${base.dir}/test"/>
  <property name="lib.dir"
            value="${base.dir}/lib"/>

  <property name="release.dir"
            value="${base.dir}/release"/>
  <property name="tmp.dir"
            value="${base.dir}/.tmp"/>

  <path id="build.classpath">
    <fileset dir="${lib.dir}">
      <include name="*.jar">
      <exclude name="jruby.jar">
    </fileset>
  </path>

  <patternset id="java.src.pattern">
    <include name="**/*.java"/>
    <exclude unless="bsf.present" name="org/jruby/javasupport/bsf/**/*.java"/>
    <exclude unless="oro.present" name="**/ORORegexpAdapter.java"/>
    <exclude unless="jdk1.4+" name="**/JDKRegexpAdapter.java"/>
    <exclude unless="gnuregexp.present" name="**/GNURegexpAdapter.java"/>
  </patternset>

  <patternset id="ruby.src.pattern">
    <include name="**/*.rb"/>
  </patternset>

  <patternset id="other.src.pattern">
    <include name="**/*.properties"/>
  </patternset>

  <target name="init" description="initialize the build">
    <xmlproperty file="build-config.xml" keepRoot="false" collapseAttributes="true"/>
    <tstamp>
      <format property="build.date" pattern="yyyy-MM-dd"/>
    </tstamp>
    <property name="version.ruby" value="${version.ruby.major}.${version.ruby.minor}"/>
  </target>

  <target name="check-for-optional-packages"
          description="check if specific libs and versions are avaiable"
	  depends="init">
    <available property="jdk1.4+"
               classname="java.lang.CharSequence"/>
    <available property="bsf.present"
               classname="com.ibm.bsf.BSFManager"
               classpathref="build.classpath"/>
    <available property="junit.present"
               classname="junit.framework.TestCase"
               classpathref="build.classpath"/>
    <available property="oro.present"
               classname="org.apache.oro.text.regex.Perl5Pattern"
               classpathref="build.classpath"/>
    <available property="gnuregexp.present"
               classname="gnu.regexp.RE"
	       classpathref="build.classpath"/>
  </target>

  <target name="compile-src" description="compile the src directory" depends="init,check-for-optional-packages">
    <mkdir dir="${tmp.dir}/src"/>
 
    <copy todir="${tmp.dir}/src">
      <fileset dir="${src.dir}">
        <patternset refid="java.src.pattern"/>
        <patternset refid="ruby.src.pattern"/>
        <patternset refid="other.src.pattern"/>
      </fileset>
      <filterchain>
        <expandproperties/>
      </filterchain>
    </copy>
	  
    <javac destdir="${tmp.dir}/src">
      <classpath refid="build.classpath"/>
      <src path="${tmp.dir}/src"/>
      <patternset refid="java.src.pattern"/>
    </javac>
  </target>

  <target name="compile-test" description="compile the test directory"
	  depends="check-for-optional-packages,init">
  </target>

  <target name="compile"
          description="compile JRuby"
	  depends="compile-src,compile-test">
  </target>

  <target name="create-jar" description="create the jruby.jar" depends="compile">
    <jar destfile="${lib.dir}/jruby.jar">
      <fileset dir="${tmp.dir}/src">
        <include name="**/*.class"/>
	    <include name="**/*.properties"/>
	    <include name="**/*.rb"/>
      </fileset>
      <manifest>
        <attribute name="Built-By" value="${user.name}"/>
        <attribute name="Main-Class" value="org.jruby.Main"/>
      </manifest>
    </jar>
  </target>
</project>
